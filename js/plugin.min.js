(function ($) {
	"use strict";

	$(function () {
		var temp_text = "";
		var temp_top = "";
		var temp_left = "";

		function ia_killanot(){
			// Удалить выделение и скрыть поле ввода комментария
			$(".anotBox").remove();
			$(".anotText").css({"display":"none"});
		}

		function ia_showhide(elem, cl, ch, ms) {
			var vis = elem.attr("vis");
			if (vis == 'on') {
				$(elem.closest(cl)).children(ch).fadeOut(ms);
				elem.attr("vis", "off");
				elem.removeClass("hide");
				elem.addClass("show");
			} else {
				$(elem.closest(cl)).children(ch).fadeIn(ms);
				elem.attr("vis", "on");
				elem.removeClass("show");
				elem.addClass("hide");
			}
		}

		function annot_edited(annot) {
			var endtime = annot.find('.ia-endedit').css({"display":"none"});
			annot.children('.ia-edit').before(endtime);
			annot.children('.ia-edit-form').remove();
			annot.removeClass('ia-edited');
			annot.children('.ia-text').css({"display":"block"});
			annot.children('.ia-edit').removeClass('ia-di-none');
			annot.children('.ia-del').removeClass('ia-di-none');
		}

		$('[data-countdown]').each(function() {
			var $this = $(this), finalDate = $(this).data('countdown');
			$this.countdown(finalDate, function(event) {
				$this.html(event.strftime('%M:%S'));
			});
			$this.on('finish.countdown', function(event) {
				$this.css({"color":"rgba(255, 100, 100, 0.8)"});
				$this.closest('.ia-edit-form').find(".edit-annot-ok").attr("disabled", "disabled").removeClass('ia-ok').addClass('ia-disabled');
			});
		});

		$('.ia-annotation').on('click', '.ia-reply', function (e) {
			var article = $(this).parents('article');
			var img = article.find('.comment-content .comment-image img');
			
			console.log('reply');
			console.log($(this));
			console.log($(this).parents('article'));
			console.log(article.find('.comment-content .comment-image img'));


			var display = 'block';

			// if ($(".anotText").css("display") == 'none') {
			// 	display = 'block';				
			// }

			// $(".anotText").css({"display":display,"top":ctope + "px", "left":cleft+"px"})

			// if ($($(this).closest('.ia-main')).is('.ia-main')) {
			// 	$($(this).closest('.ia-main')).after($(".anotText"));
			// } else {
			// 	$($(this).closest('.comment-image')).after($(".anotText"));
			// }
		});

		$('.comment-image').on('click', 'img', function (e) {
			
			$(".anotBox").remove();
			$($(this).parent()).css({"position":"relative"});

			var offset = $(this).offset();			

			var relativeX = (e.pageX - offset.left);
			var relativeY = (e.pageY - offset.top);
			// получаем точку клика мышкой по картинке. Если какая-то координата находится в районе 15 пикселей от границы изображения
			// меняем значение на +-16, дабы поле не выходило за границу изображения
			if (relativeX < 16) {
				relativeX = 16;
			}
			if (relativeX > (e.target.width - 16)) {
				relativeX = e.target.width - 16;
			}
			if (relativeY < 16) {
				relativeY = 16;
			}
			if (relativeY > (e.target.height - 16)) {
				relativeY = e.target.height - 16;
			}

			// позиция поля для комментария
			var ctope = offset.top + e.target.height + 10;
			var cleft = offset.left;

			var display = 'block';

			if ($(".anotText").css("display") == 'none') {
				display = 'block';				
			}

			$(".anotText").css({"display":display,"top":ctope + "px", "left":cleft+"px"})

			if ($($(this).closest('.ia-main')).is('.ia-main')) {
				$($(this).closest('.ia-main')).after($(".anotText"));
			} else {
				$($(this).closest('.comment-image')).after($(".anotText"));
			}

			// Добавление поля выделения
			$($(this)).after('<div class="anotBox"></div>');
			// Установка его под курсор
			$(".anotBox").css({"top":((relativeY - 15) / (e.target.height / 100)) + "%", "left":((relativeX - 15) / (e.target.width / 100)) + "%", "position":"absolute"})
			// Добавить возможность перемещения в пределах изображения
			$(".anotBox").draggable({ containment:$(this), scroll:false });
			// Добавить возможность изменения размера. Пропорционально. Без вомзможности сделать меньше значений по умолчанию.
			$(".anotBox").resizable({
				containment: $(this),
				handles: "all",
				minHeight: 30,
  				minWidth: 30
			});
		});		
		
		$('.ia-main').on('click', '.ia-area-vis-switch', function (e) {
			ia_showhide($(this), ".ia-main", ".ia-area", 300);
		});

		$('.ia-main').on('click', '.ia-annotations-vis-switch', function (e) {
			ia_showhide($(this), ".comment-content", ".ia-annotations", 500);
		});

		$('body').on('click', '.new-annot-cancel', function (e) {
			// при нажатии на кнопку Cancel, удаляем поле на картинке
			ia_killanot();

		});

		$('body').on('click', '.new-annot-ok', function (e) {
			// получаем данные для отправки комментария:
			// текст комментария
			var text = document.getElementById("ia-textarea").value;
			// позицию и размер поля отметки
			var box = $(".anotBox");
			var im = box.closest('.comment-image');
			var imwidth = im.width() / 100;
			var imheight = im.height() / 100;
			var top = box.position().top / imheight;
			var left = box.position().left / imwidth;
			var sidew = box.width() / imwidth;
			var sideh = box.height() / imheight;
			// номер комментария(с картинкой) на странице, для которой добавляется новый комментария
			var img = box.closest('article').attr('id');
			// защитный механизм (http://codex.wordpress.org/WordPress_Nonces)
			var nonce = $(this).attr('nonce');

			if (text != "" && (text != temp_text || left != temp_left || top != temp_top)) {
				temp_text = text;
				temp_top = top;
				temp_left = left;
				var time = new Date();
				var usertime = (time.getMonth() + 1) + '/' + time.getDate() + '/' + time.getFullYear() + ' ' + time.getHours() + ':' + time.getMinutes() + ':' + time.getSeconds();
				$.ajax({
					type: "POST",
					url: "/wp-admin/admin-ajax.php",
					data: 	"action=add_annotation&text=" + text + 
							"&top=" + top + 
							"&left=" + left + 
							"&sidew=" + sidew + 
							"&sideh=" + sideh +  
							"&img=" + img + 
							"&nonce=" + nonce + 
							"&usertime=" + usertime,
					success: function(data){
						if (data == "addok") {
							$("#ia-textarea").val("");
							ia_killanot();
							location.reload();
						}    					
					}
				});
			} else {
				console.log(":(");
			}
		});

		$('.ia-annotation').on('click', '.ia-del', function (e) {
			if (confirm("Are you sure you want to delete the comment?")) {
				var delid = $(this).closest('.ia-annotation').attr('ia-id');
				var commimg = $(this).closest('article').attr('id');
				// защитный механизм (http://codex.wordpress.org/WordPress_Nonces)
				var nonce = $(this).attr('nonce');
				$.ajax({
					type: "POST",
					url: "/wp-admin/admin-ajax.php",
					data: "action=del_annotation&delid=" + delid + "&commimg=" + commimg + "&nonce=" + nonce,
					success: function(data){
						if (data == "delok") {
							$('[ia-id = ' + delid + ']').fadeOut(500).remove();
						}    					
					}
				});
			};
		});

		$('.ia-annotation').on('click', '.ia-edit', function (e) {
			var editann = $(this).closest('.ia-annotation');
			if (editann.hasClass('ia-edited')) {
				return;
			} else {
				editann.addClass('ia-edited');
				editann.children('.ia-edit').addClass('ia-di-none');
				editann.children('.ia-del').addClass('ia-di-none');
				var timer = editann.children('.ia-endedit');
				var bclass = 'ia-ok';
				if (timer.text() == '00:00') {
					bclass = 'ia-disabled';
				}
				var edit = editann.children('.ia-text');
				var edittext = $.trim(edit.text());
				edit.css({"display":"none"});
				var newelem = 	'<div class="ia-edit-form"><textarea class="ia-annot-edit">' + edittext + '</textarea>' +
								'<button class="ia-cancel edit-annot-cancel" type="cancel">cancel</button><button class="' + bclass + ' edit-annot-ok">ok</button></div>';
				$(editann.children('.ia-author')).after(newelem);				
				editann.children('textarea').focus();
				var form = $(editann.find('.ia-edit-form'));
				$(form.children('.edit-annot-cancel')).after(timer.css({"display":"inline-block"}));
			}
		});

		$('.ia-annotation').on('click', '.edit-annot-cancel', function (e) {
			var annot = $(this).closest('.ia-annotation');
			annot_edited(annot);
		});

		$('.ia-annotation').on('click', '.edit-annot-ok', function (e) {
			var annot = $(this).closest('.ia-annotation');
			var newannot = annot.find('.ia-annot-edit').val();
			var nonce = annot.children('.ia-edit').attr('nonce');
			var annotid = annot.attr('ia-id');
			if (newannot != "") {
				$.ajax({
					type: "POST",
					url: "/wp-admin/admin-ajax.php",
					data: 	"action=edit_annotation&text=" + newannot +   
							"&id=" + annotid + 
							"&nonce=" + nonce,
					success: function(data){
						if (data == "editok") {
							annot.children('.ia-text').html(newannot);
							annot_edited(annot);
						}
					}
				});
			} else {
				console.log(":(");
			}
		});

		$('.ia-main').on('click', '.ia.ia-area', function (e) {
			console.log("click!");
		});

		// подсветка выделения и комментария при наведении
		$('.ia.ia-area').hover(			
			function(){
				var coiid = $(this).attr("ia-id");
				$('[ia-id = ' + coiid + ']').addClass("hovered");
				if (!$(".ia-hover-cloud").is("[ia-id = " + coiid + "]")) {
					var position_hover = $(this).position();
					var position_width = $(this).width();
					var position_height = $(this).height();
					var color = $(this).css("border-color");
					$(this).after('<div class="ia-hover-cloud" ia-id=' + coiid + 
						' style="top:' + (position_hover.top + position_height - 10) +
						'px;left: ' + (position_hover.left) + 'px;"><div class="ia-hover-cloud-text"><strong style="color:'+color+';">' + 
						$('li[ia-id = ' + coiid + '] .ia-author').html() + '</strong> ' +
						$('li[ia-id = ' + coiid + '] .ia-text').html() +'</div></div>')
				}
			},
			function(){
				var coiid = $(this).attr("ia-id");				
			}
		);

		$('.ia.ia-area').mouseleave(function(event) {
			var element_hover = event.relatedTarget;			
			var coiid = $(this).attr("ia-id");

			if ($(element_hover).attr("ia-id") == coiid && $(element_hover).hasClass("ia-hover-cloud")) {
				
				$('.ia-hover-cloud[ia-id = ' + coiid + ']').mouseenter(function(event) {
					var element_enter = event.relatedTarget;
					if ($(element_enter).attr("ia-id") != coiid && !$(element_enter).hasClass("ia-area")) {
						$(this).remove();
						$('[ia-id = ' + coiid + ']').removeClass("hovered");
					}
				});
				$('.ia-hover-cloud[ia-id = ' + coiid + ']').mouseleave(function(event) {
					var element_out = event.relatedTarget;
					if ($(element_out).attr("ia-id") != coiid) {
						$(this).remove();
						$('[ia-id = ' + coiid + ']').removeClass("hovered");
					}
				});
			} else {
				$('.ia-hover-cloud[ia-id = ' + coiid + ']').remove();
				$('[ia-id = ' + coiid + ']').removeClass("hovered");
			}			
		});

		$(document).keyup(function(e){
			if(e.keyCode==27 && $(".anotBox").is(":visible")){
				ia_killanot();
				return false;
			}
		});

	});

}(jQuery));